name: Build and Create Tag

run-name: ${{ github.actor }} is Building and Tagging Anchor Version ${{ github.event.inputs.version }} ðŸš€

on:
  workflow_dispatch:
    inputs:
      version:
        description: The version to bump to in "Vx.x.x" format
jobs:
  Test-Build:
    runs-on: ubuntu-latest
    steps:
      - name: Extract branch name
        shell: bash
        run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >>$GITHUB_OUTPUT
        id: extract_branch

      # Checkout the main branch of this repo
      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          repository: lukehagar/anchor
          path: anchor
          ref: ${{ steps.extract_branch.outputs.branch }}

      # Checkout the main branch of api-specs
      - name: Checkout API Specs Repo
        uses: actions/checkout@v3
        with:
          repository: sailpoint-oss/api-specs
          path: api-specs
          ref: main

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install swagger-cli
        run: |
          npm install -g swagger-cli

      - name: Dereference and Bundle Beta API Specification
        id: buildBeta
        run: |
          swagger-cli bundle --dereference api-specs/idn/sailpoint-api.beta.yaml -t json -o anchor/src/routes/api-client/BetaSpec.json

      - name: Dereference and Bundle V3 API Specification
        id: buildV3
        if: steps.buildBeta.outcome == 'success'
        run: |
          swagger-cli bundle --dereference api-specs/idn/sailpoint-api.v3.yaml -t json -o anchor/src/routes/api-client/V3Spec.json

      - name: Dereference and Bundle V2 API Specification
        id: buildV2
        if: steps.buildV3.outcome == 'success'
        run: |
          swagger-cli bundle --dereference api-specs/idn/sailpoint-api.v2.yaml -t json -o anchor/src/routes/api-client/V2Spec.json

      - name: Dereference and Bundle CC API Specification
        id: buildCC
        if: steps.buildV2.outcome == 'success'
        run: |
          swagger-cli bundle --dereference api-specs/idn/sailpoint-api.cc.yaml -t json -o anchor/src/routes/api-client/CCSpec.json

      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: anchor/
          branch: ${{ steps.extract_branch.outputs.branch }}
          commit_message: Updated API Specifications
          file_pattern: 'src/routes/api-client/*.json'

      - name: Update manifest.json version
        id: updatePackageJsonVersion
        if: steps.buildExtension.outcome == 'success'
        run: |
          jq '.version = "${{ github.event.inputs.version }}"' static/manifest.json > static/manifest.json.tmp && mv static/manifest.json.tmp static/manifest.json

      - name: Install Dependencies
        id: installDeps
        if: steps.buildCC.outcome == 'success'
        run: |
          cd anchor
          yarn install

      - name: Build Extension
        id: buildExtension
        if: steps.installDeps.outcome == 'success'
        run: |
          cd anchor
          yarn build

      - name: Create Tag
        run: git tag V${{ github.event.inputs.version }}

      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          repository: anchor/
          branch: ${{ steps.extract_branch.outputs.branch }}
          commit_message: Updated Extension Manifest
          file_pattern: 'static/manifest.json'
